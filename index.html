<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>MBTI ë…¸ë˜ ì¶”ì²œ (ì›¹ ì‹¤í–‰)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script type="module" src="https://pyscript.net/releases/2024.9.1/core.js"></script>
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.9.1/core.css">
  <style>
    body{font-family:system-ui,Apple SD Gothic Neo,Segoe UI,sans-serif;max-width:780px;margin:36px auto;padding:0 16px}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:18px;margin-top:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:10px;border:0;background:#111827;color:#fff;cursor:pointer}
    select,input{padding:10px;border-radius:10px;border:1px solid #d1d5db}
    .muted{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <h1>ğŸµ MBTI ê¸°ë°˜ ë…¸ë˜ ì¶”ì²œ (ì„¤ì¹˜ ì—†ì´ ì›¹ì—ì„œ ì‹¤í–‰)</h1>
  <p class="muted">í•™êµ PCì—ì„œë„ ë§í¬ë§Œ ì—´ë©´ ì‹¤í–‰ë©ë‹ˆë‹¤. ë°ì´í„°ëŠ” ì €ì¥ì†Œì˜ CSVë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>

  <div class="card">
    <div class="row">
      <label for="mbti">MBTI</label>
      <select id="mbti">
        <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
        <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
        <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
        <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
      </select>
      <button id="btn">ë…¸ë˜ ì¶”ì²œë°›ê¸°</button>
    </div>
    <div id="status" class="muted" style="margin-top:8px;">CSV ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
    <div id="out" style="margin-top:14px;"></div>
  </div>

  <py-script>
from pyscript import when
from js import document, window
import random, asyncio

songs = {}  # MBTI -> list[(title, artist, url)]

def set_html(id, html): document.getElementById(id).innerHTML = html
def esc(s): return (s or "").replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")

async def load_csv_same_origin():
    # ì €ì¥ì†Œ ë£¨íŠ¸ì— 'korean_songs_mbti_2500.csv'ê°€ ìˆë‹¤ê³  ê°€ì •
    from pyodide.http import pyfetch
    url = "/HEY/korean_songs_mbti_2500.csv"  # repo ì´ë¦„ì— ë§ì¶°ì„œ ê²½ë¡œ ê³ ì •
    resp = await pyfetch(url, method="GET")
    if not resp.ok: raise RuntimeError(f"HTTP {resp.status}")
    text = await resp.string()
    lines = [ln.strip() for ln in text.splitlines() if ln.strip()]
    header = [h.strip().lower() for h in lines[0].split(",")]
    def idx(name): 
        try: return header.index(name)
        except: return -1
    i_title, i_artist, i_mbti = idx("title"), idx("artist"), idx("mbti")
    if min(i_title, i_artist, i_mbti) < 0:
        raise RuntimeError("CSV í—¤ë”ì— title, artist, MBTI ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
    tmp = {}
    for ln in lines[1:]:
        cols = [c.strip() for c in ln.split(",")]
        if i_mbti >= len(cols): continue
        title  = cols[i_title]  if i_title  < len(cols) else ""
        artist = cols[i_artist] if i_artist < len(cols) else ""
        mbti   = (cols[i_mbti]  if i_mbti  < len(cols) else "").upper()
        if not title or not mbti: 
            continue
        q = esc((title + " " + artist).strip())
        url = f"https://www.youtube.com/results?search_query={q}"
        tmp.setdefault(mbti, []).append((title, artist, url))
    return tmp

async def boot():
    try:
        global songs
        songs = await load_csv_same_origin()
        total = sum(len(v) for v in songs.values())
        set_html("status", f"âœ… CSV ë¡œë“œ ì™„ë£Œ: {len(songs)}ê°œ ìœ í˜• / {total}ê³¡")
    except Exception as e:
        set_html("status", f"âŒ CSV ë¡œë“œ ì‹¤íŒ¨: {esc(str(e))} â€” íŒŒì¼ëª…/ê²½ë¡œ í™•ì¸")

asyncio.ensure_future(boot())

@when("click", selector="#btn")
def recommend(evt):
    mbti = document.getElementById("mbti").value
    data = songs.get(mbti, [])
    if not data:
        set_html("out", f"<b>{esc(mbti)}</b> ìœ í˜• ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return
    title, artist, url = random.choice(data)
    html = f"""
      <div class='card'>
        <div><b>ì¶”ì²œ ê³¡:</b> {esc(title)}</div>
        <div><b>ì•„í‹°ìŠ¤íŠ¸:</b> {esc(artist)}</div>
        <div style='margin-top:8px'>
          <button onclick="window.open('{url}','_blank')">ìœ íŠœë¸Œì—ì„œ ë“£ê¸°</button>
        </div>
      </div>
    """
    set_html("out", html)
  </py-script>
</body>
</html>
